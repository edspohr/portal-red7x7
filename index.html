<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Usuarios - Red7x7</title>
    <link rel="icon" href="img/logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #4B5563; /* Lighter Gray */
            color: white;
        }
        .btn-primary:hover {
            background-color: #374151; /* Darker Gray on hover */
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-google {
            background-color: #4285F4;
            color: white;
        }
        .btn-google:hover {
            background-color: #357ae8;
        }
        .btn-upgrade {
            background-color: #f59e0b;
            color: white;
        }
        .btn-upgrade:hover {
            background-color: #d97706;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-socio7x7 { background-color: #d1fae5; color: #065f46; }
        .badge-pro { background-color: #fee2e2; color: #991b1b; }
        .badge-admin { background-color: #dbeafe; color: #1e40af; }

        #app-screen, #profile-screen, #loading-screen, #auth-container {
            display: none;
        }

        #whatsapp-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
            z-index: 1000;
        }
        #whatsapp-button:hover {
            transform: scale(1.1);
        }
        #whatsapp-button img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        /* --- New Auth Screen Styles --- */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #auth-container {
            background: linear-gradient(-45deg, #f9fafb, #f3f4f6, #e5e7eb, #d1d5db);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
        }

        .auth-form-wrapper {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 420px;
            padding: 2.5rem;
            animation: fade-in-up 0.6s ease-out forwards;
            opacity: 0;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(25px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-container.hidden {
            display: none;
        }
        
        @keyframes form-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-fade-in {
            animation: form-fade 0.4s ease-in-out forwards;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10" style="color: #4B5563;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-600">Cargando Red7x7...</p>
        </div>
    </div>


    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-form-wrapper">
            <div class="text-center mb-8">
                 <img src="img/logo.png" alt="Red7x7 Logo" class="w-24 mx-auto mb-4">
                 <h2 id="auth-title" class="text-2xl font-bold text-gray-800">Iniciar Sesi√≥n</h2>
            </div>
            
            <!-- Login Form -->
            <div id="login-form-container" class="form-container">
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div class="mb-4">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div class="text-right mb-4">
                        <a href="#" id="forgot-password-link" class="text-sm text-gray-600 hover:underline">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Ingresar</button>
                </form>
                <div class="my-4 flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="mx-4 text-gray-500 text-sm">o</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <div>
                    <button id="google-login-button" class="btn btn-google w-full opacity-50 cursor-not-allowed">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 24c0-1.56-.14-3.08-.4-4.54H24v8.6h11.5c-.48 2.78-1.9 5.14-3.9 6.7v5.5h7.1c4.17-3.83 6.57-9.4 6.57-16.26z" fill="#4285F4"></path><path d="M24 45c6.5 0 12-2.14 16-5.74l-7.1-5.5c-2.14 1.44-4.88 2.3-7.9 2.3-6.1 0-11.27-4.1-13.12-9.7H3.4v5.7C7.9 40.5 15.4 45 24 45z" fill="#34A853"></path><path d="M10.88 29.3c-.34-.98-.52-2.02-.52-3.1 0-1.08.18-2.12.52-3.1V17.4H3.4C2.5 19.3 2 21.6 2 24c0 2.4.5 4.7 1.4 6.6l7.48-5.7z" fill="#FBBC05"></path><path d="M24 9.2c3.54 0 6.7 1.22 9.2 3.6l6.3-6.3C36 2.1 30.5 0 24 0 15.4 0 7.9 4.5 3.4 11.7l7.48 5.7c1.85-5.6 7.02-9.7 13.12-9.7z" fill="#EA4335"></path></svg>
                        Continuar con Google
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-1">Pronto Disponible</p>
                </div>
                <p class="mt-6 text-center text-sm">¬øNo tienes cuenta? <a href="#" id="register-link" class="text-gray-700 font-medium hover:underline">Reg√≠strate</a></p>
            </div>

            <!-- Register Form -->
            <div id="register-form-container" class="form-container hidden">
                <form id="register-form" class="space-y-3">
                    <input type="text" id="register-name" placeholder="Nombre Completo" required class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <input type="email" id="register-email" placeholder="Email" required class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <input type="password" id="register-password" placeholder="Contrase√±a" required class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <input type="text" id="register-company" placeholder="Empresa" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <input type="text" id="register-position" placeholder="Cargo" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <input type="tel" id="register-phone" placeholder="Tel√©fono" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <button type="submit" class="btn btn-primary w-full !mt-5">Registrarse</button>
                </form>
                <p class="mt-6 text-center text-sm">¬øYa tienes cuenta? <a href="#" id="login-link-from-register" class="text-gray-700 font-medium hover:underline">Ingresa aqu√≠</a></p>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgot-password-form-container" class="form-container hidden">
                <p class="text-sm text-gray-600 mb-4 text-center">Ingresa tu email para restablecer tu contrase√±a.</p>
                <form id="forgot-password-form">
                    <input type="email" id="forgot-email" placeholder="Email" required class="mb-4 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    <button type="submit" class="btn btn-primary w-full">Enviar enlace</button>
                </form>
                <p class="mt-6 text-center text-sm"><a href="#" id="login-link-from-forgot" class="text-gray-700 font-medium hover:underline">Volver a inicio de sesi√≥n</a></p>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold" style="color: #4B5563;">Red7x7</h1>
                    <div class="flex items-center space-x-4">
                        <div id="user-info" class="text-right">
                            <p class="font-semibold text-gray-800"></p>
                            <p id="user-email-role" class="text-sm text-gray-500"></p>
                        </div>
                        <img id="user-avatar" class="h-10 w-10 rounded-full" src="" alt="User Avatar">
                        <a href="https://www.red7x7.cl/suscripcion" target="_blank" id="upgrade-to-pro-btn" class="btn btn-upgrade hidden">
                            <i data-lucide="star" class="w-4 h-4 mr-2"></i> Hazte Pro
                        </a>
                        <button id="profile-button" class="btn btn-secondary">
                            <i data-lucide="user-cog" class="w-4 h-4 mr-2"></i> Mi Perfil
                        </button>
                        <button id="logout-button" class="btn btn-primary">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Admin-only panels -->
            <div id="admin-panels-container" class="hidden">
                <!-- Create Announcement -->
                <div class="card">
                    <h2 class="section-title">Crear Anuncio</h2>
                    <textarea id="announcement-text" class="w-full p-2 border rounded-md" rows="3" placeholder="Escribe tu anuncio aqu√≠..."></textarea>
                    <div class="flex justify-between items-center mt-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="pin-announcement" class="h-4 w-4 border-gray-300 rounded focus:ring-gray-500" style="color: #4B5563;">
                            <label for="pin-announcement" class="ml-2 block text-sm text-gray-900">Fijar con chincheta</label>
                        </div>
                        <button id="submit-announcement" class="btn btn-primary">
                             <i data-lucide="send" class="w-4 h-4 mr-2"></i> Publicar
                        </button>
                    </div>
                </div>
                <!-- Add User -->
                 <div class="card">
                    <h2 class="section-title">A√±adir Nuevo Usuario</h2>
                    <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="add-user-name" placeholder="Nombre Completo" required class="p-2 border rounded-md">
                        <input type="email" id="add-user-email" placeholder="Email" required class="p-2 border rounded-md">
                        <input type="text" id="add-user-company" placeholder="Empresa" class="p-2 border rounded-md">
                        <input type="text" id="add-user-position" placeholder="Cargo" class="p-2 border rounded-md">
                        <input type="tel" id="add-user-phone" placeholder="Tel√©fono" class="p-2 border rounded-md">
                        <button type="submit" class="btn btn-primary md:col-span-2 lg:col-span-1">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> A√±adir Usuario
                        </button>
                    </form>
                </div>
            </div>

            <!-- Announcements Panel -->
            <div class="card">
                <h2 class="section-title">üì£ Panel de Anuncios</h2>
                <div id="announcements-list" class="space-y-4">
                    <!-- Announcements will be injected here -->
                </div>
            </div>

            <!-- Admin-only: Create Meeting -->
            <div id="admin-meeting-panel" class="hidden mb-6">
                <div class="card relative">
                     <div id="ai-loader" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10">
                        <div class="flex flex-col items-center">
                             <svg class="animate-spin h-8 w-8 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-gray-600">Procesando con IA...</p>
                        </div>
                    </div>
                    <h2 class="section-title">Registrar Reuni√≥n</h2>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                        <label for="meeting-notes-text" class="block text-sm font-medium text-gray-700 mb-1">Pega aqu√≠ las notas de la reuni√≥n</label>
                        <textarea id="meeting-notes-text" placeholder="Pega el contenido de tu Google Doc o similar aqu√≠..." class="w-full p-2 border rounded-md" rows="5"></textarea>
                        <div class="flex justify-end mt-2">
                           <button id="process-meeting-ai" class="btn btn-secondary">
                               <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Analizar con IA
                           </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">La IA analizar√° el texto, generar√° un resumen y seleccionar√° a los participantes.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="meeting-title" type="text" placeholder="T√≠tulo de la reuni√≥n" class="w-full p-2 border rounded-md">
                        <input id="meeting-date" type="date" class="w-full p-2 border rounded-md">
                    </div>
                    <textarea id="meeting-summary" class="w-full p-2 border rounded-md mt-4" rows="4" placeholder="Resumen de la reuni√≥n..."></textarea>
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Participantes</h3>
                        <div id="meeting-participants-list" class="max-h-60 overflow-y-auto border rounded-md p-2 space-y-2">
                           <!-- User list for selection will be injected here -->
                        </div>
                    </div>
                    <div class="text-right mt-4">
                        <button id="submit-meeting" class="btn btn-primary">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Reuni√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- My Meetings Panel -->
            <div class="card">
                <h2 class="section-title">üóìÔ∏è Mis Reuniones</h2>
                <div id="meetings-list" class="space-y-6">
                    <!-- Meetings will be injected here -->
                </div>
            </div>
            
            <!-- User Directory -->
            <div class="card">
                <h2 class="section-title">üë• Directorio de Miembros</h2>
                <div class="mb-4">
                    <input id="search-directory" type="text" placeholder="Buscar por nombre, cargo o empresa..." class="w-full p-2 border rounded-md">
                </div>
                <div id="directory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- User cards will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Screen -->
    <div id="profile-screen" class="min-h-screen">
        <div class="max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="card">
                <h2 class="section-title">Mi Perfil</h2>
                <p class="text-sm text-gray-500 mb-6">Completa y actualiza tus datos para que la comunidad pueda conocerte mejor.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                        <input type="text" id="profile-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div>
                        <label for="profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="profile-email" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" disabled>
                    </div>
                    <div>
                        <label for="profile-company" class="block text-sm font-medium text-gray-700">Empresa</label>
                        <input type="text" id="profile-company" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div>
                        <label for="profile-position" class="block text-sm font-medium text-gray-700">Cargo</label>
                        <input type="text" id="profile-position" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                    <div>
                        <label for="profile-phone" class="block text-sm font-medium text-gray-700">Nro. de Tel√©fono</label>
                        <input type="tel" id="profile-phone" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                    </div>
                </div>

                <div class="mt-6 flex items-center justify-end space-x-4">
                    <button id="cancel-profile" class="btn btn-secondary">Volver</button>
                    <button id="save-profile" class="btn btn-primary">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for user details -->
    <div id="user-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-20">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100">
                     <i data-lucide="contact" class="h-6 w-6" style="color: #4B5563;"></i>
                </div>
                <h3 id="modal-user-name" class="text-lg leading-6 font-medium text-gray-900 mt-2"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Aqu√≠ est√°n los datos de contacto:</p>
                    <div id="modal-user-details" class="text-left mt-4 space-y-2">
                        <!-- User details will be injected here -->
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-button" class="btn btn-primary w-full">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for editing meetings -->
    <div id="edit-meeting-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-20">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="card !p-0 !shadow-none !border-none">
                 <input type="hidden" id="edit-meeting-id">
                 <h2 class="section-title">Editar Reuni√≥n</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <input id="edit-meeting-title" type="text" placeholder="T√≠tulo de la reuni√≥n" class="w-full p-2 border rounded-md">
                     <input id="edit-meeting-date" type="date" class="w-full p-2 border rounded-md">
                 </div>
                 <textarea id="edit-meeting-summary" class="w-full p-2 border rounded-md mt-4" rows="4" placeholder="Resumen de la reuni√≥n..."></textarea>
                 <div class="mt-4">
                     <h3 class="font-semibold mb-2">Participantes</h3>
                     <div id="edit-meeting-participants-list" class="max-h-60 overflow-y-auto border rounded-md p-2 space-y-2">
                        <!-- Participant checkboxes will be injected here -->
                     </div>
                 </div>
                 <div class="text-right mt-4 space-x-2">
                    <button id="cancel-edit-meeting" class="btn btn-secondary">Cancelar</button>
                     <button id="save-meeting-changes" class="btn btn-primary">
                         <i data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Cambios
                     </button>
                 </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/56932268111?text=Soy%20miembro%20de%20la%20Red7x7%20y%20necesito%20ayuda..." target="_blank" rel="noopener noreferrer" id="whatsapp-button" class="hidden">
        <img src="img/WhatsApp_icon.png" alt="WhatsApp">
    </a>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- TU API KEY DE GOOGLE AI STUDIO ---
        const GEMINI_API_KEY = "AIzaSyDHs_dpJXr6au8SqSiYRNih5AEvpKOTQ5w";
        // --------------------------------------------------

        // --- DATA DE EJEMPLO (Simulando una base de datos) ---
        const MOCK_USERS = {
            "user1_admin": { name: "Admin Red7x7", email: "admin@red7x7.com", password: "123", company: "Red7x7", position: "Administrador", phone: "+56911111111", role: "admin" },
            "user2_pro": { name: "Javiera P√©rez", email: "javiera.perez@example.com", password: "123", company: "Tech Solutions", position: "Gerente de Proyectos", phone: "+56922222222", role: "pro", contactRequestsLeft: 5 },
            "user3_socio": { name: "Carlos Soto", email: "carlos.soto@example.com", password: "123", company: "Innovate Co.", position: "Desarrollador Frontend", phone: "+56933333333", role: "socio7x7" },
            "user4_pro": { name: "Mario Cobo Giancaspero", email: "mario.cobo@norteclaro.com", password: "123", company: "NORTECLARO", position: "Socio", phone: "+56944444444", role: "pro", contactRequestsLeft: 5 },
            "user5_socio": { name: "Pablo Marcelo Soto Bevilacqua", email: "psoto@cumplimientolean.com", password: "123", company: "Cumplimiento Lean", position: "CEO y fundador", phone: "56930686476", role: "socio7x7" },
            "user6_socio": { name: "Felipe Manuel Figueroa Zimmermann", email: "felipefigueroaz@estudiopoligonal.cl", password: "123", company: "Estudio Poligonal", position: "Director | Fundador", phone: "56984070700", role: "socio7x7" },
            "user7": { name: "Ariel Sandoval Carrasco", email: "ariel@youtouch.cl", password: "123", company: "Youtouch", position: "Lider Comercial", phone: "", role: "socio7x7" },
            "user8": { name: "Luis Alberto Arenas Asis", email: "luis.arenas@equifax-pyme.cl", password: "123", company: "Equifax", position: "Jefe de ventas", phone: "920314422", role: "socio7x7" },
            "user9": { name: "Juano Rossi", email: "juan.rossi@uosolutions.com", password: "123", company: "UO Solutions", position: "Country Manager Chile", phone: "56954140357", role: "socio7x7" },
            "user10": { name: "Eduardo Abeleida", email: "eduardo@networkcenter.cl", password: "123", company: "NetworkCenter SPA", position: "Director", phone: "569 94929383", role: "socio7x7" },
            "user11": { name: "Daniela Schlesinger", email: "daniela@letsgolatam.cl", password: "123", company: "Let's Go Latam", position: "Gerente General", phone: "", role: "socio7x7" },
            "user12": { name: "√ìscar Antonio Aguilar Castrill√≥n", email: "oscaraguilar@mentorderesultados.cl", password: "123", company: "Mentor de Resultados", position: "Director", phone: "56952296244", role: "socio7x7" },
            "user13": { name: "Valeria", email: "Valeria.alfaro@synolia.com", password: "123", company: "Synolia", position: "Ejecutivo comercial", phone: "944079791", role: "socio7x7" },
            "user14": { name: "Alexis Artus", email: "alexis.artus@insuseg.cl", password: "123", company: "INSUSEG", position: "Socio-Gerente", phone: "+56 9 9534 7922", role: "socio7x7" },
            "user15": { name: "Sebasti√°n Gelmi", email: "sebasti√°n.gelmi@epricing.cl", password: "123", company: "ePricing", position: "Comercial", phone: "+56 9 9345 3192", role: "socio7x7" },
            "user16": { name: "Felipe Cousi√±o", email: "fcousino@imagina.cl", password: "123", company: "Imagina", position: "Gerente Comercial", phone: "+56994357283", role: "socio7x7" },
            "user17": { name: "Dario Damian Vercellini", email: "Dvercellini@agenciaolivares.cl", password: "123", company: "AGENCIA DE ADUANA OLIVARES", position: "Comercial", phone: "+569 9897 9248", role: "socio7x7" },
            "user18": { name: "JORGE RAMON CORDOVA VIERA", email: "MANAGER@VIERALOGISTICS.CL", password: "123", company: "VIERA LOGISTICS", position: "MANAGER", phone: "56977031013", role: "socio7x7" },
            "user19": { name: "CAROLINA ALEJANDRA LOPEZ OLIVARES", email: "clopez@agenciaolivares.cl", password: "123", company: "AGENCIA DE ADUANA PATRICIO OLIVARES Y CIA. LTDA. / OLM OLIVARES", position: "GTE OPERACIONES", phone: "56982398254", role: "socio7x7" },
            "user20": { name: "Francisca Mendez", email: "francisca.mendez@grupochic.cl", password: "123", company: "GrupoChic S.A", position: "Socia fundadora/gerente general", phone: "992769336", role: "socio7x7" },
            "user21": { name: "Jorge Pereira Y√°√±ez", email: "jpereiray@gmail.com", password: "123", company: "SAG-F", position: "Owner", phone: "56967160933", role: "socio7x7" },
            "user22": { name: "Gonzalo Avila Bonilla", email: "Gonzalo@insideplace.cl", password: "123", company: "Insideplace office & Retail S.p.a", position: "Director comercial", phone: "9 7979 6120", role: "socio7x7" },
            "user23": { name: "Julio Ortiz", email: "jortiz@prixus.cl", password: "123", company: "Prixus Erp", position: "Jefe Comercial", phone: "988385090", role: "socio7x7" },
            "user24": { name: "Sergio Ponce", email: "sponce@turingears.com", password: "123", company: "TurinGears", position: "CEO", phone: "+56 9 9615 4789", role: "socio7x7" },
            "user25": { name: "Liliana Becerra", email: "liliana.becerra@innatel.com.co", password: "123", company: "INNATEL SAS BIC", position: "Gerente de Proyectos", phone: "3205791525", role: "socio7x7" },
            "user26": { name: "Maximiliano Viveros Rojas", email: "mviveros@playmkt.cl", password: "123", company: "Play MKT", position: "Gerente de Desarrollo de Negocios", phone: "56994894647", role: "socio7x7" },
            "user27": { name: "Barbara Ruz Vargas", email: "barbara@igromi.com", password: "123", company: "iGromi", position: "Directora de nuevos negocios", phone: "56953331750", role: "socio7x7" },
            "user28": { name: "Javier Gallardo Warden", email: "jgallardow@i3g.cl", password: "123", company: "I3G - Ciberseguridad", position: "Gerente General", phone: "56965748888", role: "socio7x7" },
        };

        for (const [id, user] of Object.entries(MOCK_USERS)) {
            user.photoURL = `https://placehold.co/100x100/${user.role === 'admin' ? 'dbeafe/1e40af' : 'd1fae5/065f46'}?text=${user.name.charAt(0)}`;
        }
        
        let MOCK_ANNOUNCEMENTS = [
            { id: "a1", text: "¬°Bienvenidos a la nueva plataforma de Red7x7! Explora las nuevas funcionalidades y conecta con otros miembros.", isPinned: true, author: "Admin Red7x7", date: "2024-09-15" },
            { id: "a2", text: "El pr√≥ximo encuentro de networking ser√° el 25 de Octubre. ¬°No te olvides de confirmar tu asistencia!", isPinned: false, author: "Admin Red7x7", date: "2024-09-12" },
        ];

        let MOCK_MEETINGS = [
            { 
                id: "m1", 
                title: "Encuentro de Innovaci√≥n y Tecnolog√≠a", 
                date: "2024-08-20", 
                summary: "Una excelente sesi√≥n donde discutimos las √∫ltimas tendencias en IA y desarrollo de software. Se generaron varias sinergias interesantes entre los participantes.",
                participants: ["user2_pro", "user4_pro", "user5_socio"] 
            },
            { 
                id: "m2", 
                title: "Caf√© de Negocios: Finanzas", 
                date: "2024-07-10", 
                summary: "Conversamos sobre estrategias de inversi√≥n y el panorama econ√≥mico actual. Muy buen feedback de todos los asistentes.",
                participants: ["user2_pro", "user3_socio", "user6_socio"]
            }
        ];

        // --- ESTADO DE LA APLICACI√ìN ---
        let currentUser = null; 

        // --- ELEMENTOS DEL DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const authContainer = document.getElementById('auth-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const forgotPasswordFormContainer = document.getElementById('forgot-password-form-container');
        const appScreen = document.getElementById('app-screen');
        const profileScreen = document.getElementById('profile-screen');
        const googleLoginButton = document.getElementById('google-login-button');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const logoutButton = document.getElementById('logout-button');
        const profileButton = document.getElementById('profile-button');
        const saveProfileButton = document.getElementById('save-profile');
        const cancelProfileButton = document.getElementById('cancel-profile');
        const searchDirectoryInput = document.getElementById('search-directory');
        const whatsappButton = document.getElementById('whatsapp-button');
        const processMeetingAIButton = document.getElementById('process-meeting-ai');
        const upgradeToProBtn = document.getElementById('upgrade-to-pro-btn');

        // --- FUNCIONES DE RENDERIZADO Y NAVEGACI√ìN ---
        const showAuthForm = (form) => {
            const authTitle = document.getElementById('auth-title');
            const formMap = {
                'login': { container: loginFormContainer, title: 'Iniciar Sesi√≥n' },
                'register': { container: registerFormContainer, title: 'Crear Cuenta' },
                'forgot': { container: forgotPasswordFormContainer, title: 'Recuperar Contrase√±a' }
            };
            Object.values(formMap).forEach(f => f.container.classList.add('hidden'));
            const target = formMap[form];
            if (target) {
                authTitle.textContent = target.title;
                target.container.classList.remove('hidden');
                target.container.classList.add('form-fade-in');
                target.container.addEventListener('animationend', () => target.container.classList.remove('form-fade-in'), { once: true });
            }
        }
        
        const showScreen = (screen) => {
            loadingScreen.style.display = screen === 'loading' ? 'flex' : 'none';
            authContainer.style.display = ['login', 'register', 'forgot'].includes(screen) ? 'flex' : 'none';
            appScreen.style.display = screen === 'app' ? 'block' : 'none';
            profileScreen.style.display = screen === 'profile' ? 'block' : 'none';
            if (screen === 'login') showAuthForm('login');
            if (screen === 'register') showAuthForm('register');
            if (screen === 'forgot') showAuthForm('forgot');
        }

        const renderHeader = () => {
            document.querySelector('#user-info p:first-child').textContent = currentUser.name;
            const userEmailRoleEl = document.getElementById('user-email-role');

            if (currentUser.role === 'pro') {
                userEmailRoleEl.textContent = `Pro | ${currentUser.contactRequestsLeft} contactos restantes`;
            } else {
                 userEmailRoleEl.textContent = currentUser.email;
            }

            document.getElementById('user-avatar').src = currentUser.photoURL;
            
            if(currentUser.role === 'socio7x7'){
                upgradeToProBtn.classList.remove('hidden');
            } else {
                upgradeToProBtn.classList.add('hidden');
            }
        }

        const renderAnnouncements = () => {
            const list = document.getElementById('announcements-list');
            list.innerHTML = '';
            const sorted = [...MOCK_ANNOUNCEMENTS].sort((a, b) => b.isPinned - a.isPinned);
            sorted.forEach(ann => {
                const annEl = document.createElement('div');
                annEl.className = `relative p-4 rounded-lg border ${ann.isPinned ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'}`;
                let adminActions = '';
                if (currentUser.role === 'admin') {
                    adminActions = `
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button data-id="${ann.id}" class="toggle-pin-btn p-1 text-gray-500 hover:text-gray-800" title="${ann.isPinned ? 'Quitar Chincheta' : 'Fijar con Chincheta'}">
                                <i data-lucide="${ann.isPinned ? 'pin-off' : 'pin'}" class="w-4 h-4"></i>
                            </button>
                            <button data-id="${ann.id}" class="delete-ann-btn p-1 text-gray-500 hover:text-red-600" title="Eliminar Anuncio">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        `;
                }
                annEl.innerHTML = `
                    ${adminActions}
                    <p class="text-gray-800 pr-12">${ann.text}</p>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                        <span>Por: ${ann.author} - ${ann.date}</span>
                        ${ann.isPinned ? `<span class="text-yellow-600 flex items-center"><i data-lucide="pin" class="w-4 h-4 mr-1"></i> Fijado</span>` : ''}
                    </div>`;
                list.appendChild(annEl);
            });
            lucide.createIcons();
            document.querySelectorAll('.toggle-pin-btn').forEach(button => button.addEventListener('click', handleTogglePin));
            document.querySelectorAll('.delete-ann-btn').forEach(button => button.addEventListener('click', handleDeleteAnnouncement));
        }

        const renderMeetings = () => {
            const list = document.getElementById('meetings-list');
            list.innerHTML = '';
            
            let userMeetings;
            if (currentUser.role === 'admin') {
                userMeetings = [...MOCK_MEETINGS].sort((a, b) => new Date(b.date) - new Date(a.date)); // Admin sees all meetings, sorted
            } else {
                userMeetings = MOCK_MEETINGS.filter(m => m.participants.includes(currentUser.id));
            }

            if (userMeetings.length === 0) {
                list.innerHTML = '<p class="text-gray-500">A√∫n no has participado en ninguna reuni√≥n registrada.</p>';
                return;
            }

            userMeetings.forEach(meeting => {
                const meetingEl = document.createElement('div');
                meetingEl.className = 'border-l-4 pl-4 relative';
                meetingEl.style.borderColor = '#4B5563';
                let participantsHTML = '';
                
                if (currentUser.role === 'pro' || currentUser.role === 'admin') {
                    const participantsData = meeting.participants.map(pId => MOCK_USERS[pId]).filter(Boolean);
                    participantsHTML = `
                        <h4 class="font-semibold mt-3 mb-2">Participantes:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            ${participantsData.map(p => `<li><strong>${p.name}</strong> (${p.position}, ${p.company}) - ${p.email}, ${p.phone}</li>`).join('')}
                        </ul>`;
                }

                let adminActions = '';
                if (currentUser.role === 'admin') {
                    adminActions = `
                        <div class="absolute top-0 right-0">
                            <button data-meeting-id="${meeting.id}" class="edit-meeting-btn p-1 text-gray-500 hover:text-gray-800">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                }

                meetingEl.innerHTML = `
                    ${adminActions}
                    <h3 class="font-bold text-lg">${meeting.title}</h3>
                    <p class="text-sm text-gray-500 mb-2">${meeting.date}</p>
                    ${ (currentUser.role === 'pro' || currentUser.role === 'admin') ? `<p class="text-gray-700">${meeting.summary}</p>` : '' }
                    ${participantsHTML}`;
                list.appendChild(meetingEl);
            });
            lucide.createIcons();
            document.querySelectorAll('.edit-meeting-btn').forEach(btn => btn.addEventListener('click', showEditMeetingModal));
        }

        const renderDirectory = (searchTerm = '') => {
            const list = document.getElementById('directory-list');
            list.innerHTML = '';
            const lowerCaseSearch = searchTerm.toLowerCase();
            Object.entries(MOCK_USERS).forEach(([id, user]) => {
                if (user.name.toLowerCase().includes(lowerCaseSearch) || (user.company && user.company.toLowerCase().includes(lowerCaseSearch)) || (user.position && user.position.toLowerCase().includes(lowerCaseSearch))) {
                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-lg bg-white flex flex-col items-center text-center';
                    let actionsHTML = '';
                    let roleHTML = '';

                    if (currentUser.role === 'pro' && currentUser.id !== id) {
                        actionsHTML = `<button data-user-id="${id}" class="btn btn-primary btn-sm mt-4 request-data-btn">Pedir datos</button>`;
                    } else if (currentUser.role === 'admin') {
                        actionsHTML = `
                            <div class="mt-4 w-full">
                                <p class="text-xs text-gray-600"><strong>Email:</strong> ${user.email}</p>
                                <p class="text-xs text-gray-600"><strong>Tel:</strong> ${user.phone}</p>
                                <select data-user-id="${id}" class="role-selector mt-2 w-full p-1 border rounded-md text-sm">
                                    <option value="socio7x7" ${user.role === 'socio7x7' ? 'selected' : ''}>Socio7x7</option>
                                    <option value="pro" ${user.role === 'pro' ? 'selected' : ''}>Pro</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>`;
                        
                        const roleBadges = { socio7x7: '<span class="badge badge-socio7x7">Socio7x7</span>', pro: '<span class="badge badge-pro">Pro</span>', admin: '<span class="badge badge-admin">Admin</span>' };
                        roleHTML = `<div class="mt-2">${roleBadges[user.role]}</div>`;
                    }

                    card.innerHTML = `
                        <img src="${user.photoURL}" class="w-16 h-16 rounded-full mb-3" alt="${user.name}">
                        <h4 class="font-bold text-md">${user.name}</h4>
                        <p class="text-sm text-gray-600">${user.position || ''}</p>
                        <p class="text-sm text-gray-500">${user.company || ''}</p>
                        ${roleHTML}
                        ${actionsHTML}`;
                    list.appendChild(card);
                }
            });
            document.querySelectorAll('.request-data-btn').forEach(button => button.addEventListener('click', handleRequestData));
            document.querySelectorAll('.role-selector').forEach(select => select.addEventListener('change', handleRoleChange));
        };
        
        const getTodayDateString = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        const renderAdminPanels = () => {
            const adminPanels = document.getElementById('admin-panels-container');
            const meetingPanel = document.getElementById('admin-meeting-panel');
            if (currentUser.role === 'admin') {
                adminPanels.classList.remove('hidden');
                meetingPanel.classList.remove('hidden');
                
                const today = getTodayDateString();
                document.getElementById('meeting-date').value = today;
                document.getElementById('meeting-title').value = `Reuni√≥n 7x7 - ${today}`;

                const participantsList = document.getElementById('meeting-participants-list');
                participantsList.innerHTML = '';
                Object.entries(MOCK_USERS).forEach(([id, user]) => {
                    participantsList.innerHTML += `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="participant-checkbox h-4 w-4 border-gray-300 rounded" style="color: #4B5563;" value="${id}">
                            <span>${user.name} (${user.company})</span>
                        </label>`;
                });
            } else {
                adminPanels.classList.add('hidden');
                meetingPanel.classList.add('hidden');
            }
        };

        const renderProfileForm = () => {
            document.getElementById('profile-name').value = currentUser.name || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-company').value = currentUser.company || '';
            document.getElementById('profile-position').value = currentUser.position || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            const profileCard = document.querySelector('#profile-screen .card');
            profileCard.querySelector('.upgrade-section')?.remove();
            if (currentUser.role === 'socio7x7') {
                const upgradeSection = document.createElement('div');
                upgradeSection.className = 'mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg upgrade-section';
                upgradeSection.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">Potencia tu Networking</h3>
                    <p class="text-gray-600 mt-1 mb-4">Accede a datos de contacto, res√∫menes de reuniones y m√°s.</p>
                    <a href="https://www.red7x7.cl/suscripcion" target="_blank" class="btn btn-upgrade w-full">
                        <i data-lucide="star" class="w-4 h-4 mr-2"></i> Volverme Pro Ahora
                    </a>`;
                profileCard.appendChild(upgradeSection);
                lucide.createIcons();
            }
        };

        // --- MANEJADORES DE EVENTOS (HANDLERS) ---
        const handleEmailLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const userEntry = Object.entries(MOCK_USERS).find(([id, user]) => user.email === email);
            if (userEntry && userEntry[1].password === password) {
                currentUser = { id: userEntry[0], ...userEntry[1] };
                showScreen('loading');
                setTimeout(initializeAppUI, 1000);
            } else {
                alert('Email o contrase√±a incorrectos.');
            }
        };

        const handleRegister = (e) => {
            e.preventDefault();
            const newUser = {
                name: document.getElementById('register-name').value,
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
                company: document.getElementById('register-company').value,
                position: document.getElementById('register-position').value,
                phone: document.getElementById('register-phone').value,
                role: 'socio7x7',
                photoURL: `https://placehold.co/100x100/d1fae5/065f46?text=${document.getElementById('register-name').value.charAt(0)}`
            };
            const newUserId = `user${Date.now()}`;
            MOCK_USERS[newUserId] = newUser;
            alert('¬°Registro exitoso! Ahora puedes iniciar sesi√≥n.');
            registerForm.reset();
            showScreen('login');
        };

        const handleForgotPassword = (e) => {
            e.preventDefault();
            alert(`Si existe una cuenta asociada a ${document.getElementById('forgot-email').value}, recibir√°s un correo.`);
            forgotPasswordForm.reset();
            showScreen('login');
        };

        const handleLogout = () => {
            currentUser = null;
            whatsappButton.classList.add('hidden');
            showScreen('login');
        };

        const handleTogglePin = (e) => {
            const announcementId = e.currentTarget.dataset.id;
            const announcement = MOCK_ANNOUNCEMENTS.find(ann => ann.id === announcementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned;
                renderAnnouncements();
            }
        };
        
        const handleDeleteAnnouncement = (e) => {
            const announcementId = e.currentTarget.dataset.id;
            const index = MOCK_ANNOUNCEMENTS.findIndex(ann => ann.id === announcementId);
            if (index > -1) {
                MOCK_ANNOUNCEMENTS.splice(index, 1);
                renderAnnouncements();
            }
        };

        const handleSaveProfile = () => {
            currentUser.name = document.getElementById('profile-name').value;
            currentUser.company = document.getElementById('profile-company').value;
            currentUser.position = document.getElementById('profile-position').value;
            currentUser.phone = document.getElementById('profile-phone').value;
            MOCK_USERS[currentUser.id] = { ...MOCK_USERS[currentUser.id], ...currentUser };
            alert('Perfil actualizado');
            showScreen('app');
        };

        const handleSubmitAnnouncement = () => {
            const text = document.getElementById('announcement-text').value;
            if (!text) return;
            const newAnnouncement = { id: `a${Date.now()}`, text, isPinned: document.getElementById('pin-announcement').checked, author: currentUser.name, date: new Date().toISOString().split('T')[0] };
            MOCK_ANNOUNCEMENTS.unshift(newAnnouncement);
            renderAnnouncements();
            document.getElementById('announcement-text').value = '';
            document.getElementById('pin-announcement').checked = false;
        };
        
        const handleManualAddUser = (e) => {
            e.preventDefault();
            const form = document.getElementById('add-user-form');
            const name = document.getElementById('add-user-name').value;
            const newUser = {
                name: name,
                email: document.getElementById('add-user-email').value,
                password: "123", // Default password
                company: document.getElementById('add-user-company').value,
                position: document.getElementById('add-user-position').value,
                phone: document.getElementById('add-user-phone').value,
                role: 'socio7x7', // Default role
                photoURL: `https://placehold.co/100x100/d1fae5/065f46?text=${name.charAt(0)}`
            };
            if(!newUser.name || !newUser.email) {
                alert("Nombre y Email son obligatorios.");
                return;
            }
            const newUserId = `user${Date.now()}`;
            MOCK_USERS[newUserId] = newUser;
            alert(`Usuario ${newUser.name} a√±adido como Socio7x7.`);
            form.reset();
            renderDirectory();
            renderAdminPanels(); // To refresh participant lists
        };

        const handleSubmitMeeting = () => {
            const title = document.getElementById('meeting-title').value;
            const date = document.getElementById('meeting-date').value;
            const summary = document.getElementById('meeting-summary').value;
            const selectedParticipants = Array.from(document.querySelectorAll('.participant-checkbox:checked')).map(cb => cb.value);
            if (!title || !date || !summary || selectedParticipants.length === 0) {
                alert('Por favor, completa todos los campos.'); return;
            }
            MOCK_MEETINGS.unshift({ id: `m${Date.now()}`, title, date, summary, participants: selectedParticipants });
            alert('Reuni√≥n registrada.');
            renderMeetings();
            const today = getTodayDateString();
            document.getElementById('meeting-title').value = `Reuni√≥n 7x7 - ${today}`;
            document.getElementById('meeting-date').value = today;
            document.getElementById('meeting-summary').value = '';
            document.getElementById('meeting-notes-text').value = '';
            document.querySelectorAll('.participant-checkbox').forEach(cb => cb.checked = false);
        };

        const handleRequestData = (e) => {
            if(currentUser.contactRequestsLeft <= 0){
                alert("Has agotado tus 5 contactos de este mes.");
                return;
            }

            const targetUser = MOCK_USERS[e.currentTarget.dataset.userId];
            currentUser.contactRequestsLeft--;
            renderHeader(); // Update contact count in header
            
            const modal = document.getElementById('user-details-modal');
            document.getElementById('modal-user-name').textContent = targetUser.name;
            document.getElementById('modal-user-details').innerHTML = `<p><strong>Cargo:</strong> ${targetUser.position}</p><p><strong>Empresa:</strong> ${targetUser.company}</p><p><strong>Email:</strong> ${targetUser.email}</p><p><strong>Tel√©fono:</strong> ${targetUser.phone}</p>`;
            modal.classList.remove('hidden');
        };

        const handleRoleChange = (e) => {
            const userId = e.currentTarget.dataset.userId;
            MOCK_USERS[userId].role = e.currentTarget.value;
            MOCK_USERS[userId].photoURL = `https://placehold.co/100x100/${MOCK_USERS[userId].role === 'admin' ? 'dbeafe/1e40af' : 'd1fae5/065f46'}?text=${MOCK_USERS[userId].name.charAt(0)}`;
            alert(`Rol actualizado.`);
            renderDirectory();
        };
        
        const showEditMeetingModal = (e) => {
            const meetingId = e.currentTarget.dataset.meetingId;
            const meeting = MOCK_MEETINGS.find(m => m.id === meetingId);
            if (!meeting) return;

            document.getElementById('edit-meeting-id').value = meeting.id;
            document.getElementById('edit-meeting-title').value = meeting.title;
            document.getElementById('edit-meeting-date').value = meeting.date;
            document.getElementById('edit-meeting-summary').value = meeting.summary;

            const participantsList = document.getElementById('edit-meeting-participants-list');
            participantsList.innerHTML = '';
            Object.entries(MOCK_USERS).forEach(([id, user]) => {
                const isChecked = meeting.participants.includes(id) ? 'checked' : '';
                participantsList.innerHTML += `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="edit-participant-checkbox h-4 w-4 border-gray-300 rounded" style="color: #4B5563;" value="${id}" ${isChecked}>
                        <span>${user.name} (${user.company})</span>
                    </label>
                `;
            });
            
            document.getElementById('edit-meeting-modal').classList.remove('hidden');
        };

        const handleSaveChangesToMeeting = () => {
            const meetingId = document.getElementById('edit-meeting-id').value;
            const meetingIndex = MOCK_MEETINGS.findIndex(m => m.id === meetingId);
            if (meetingIndex === -1) return;

            const updatedTitle = document.getElementById('edit-meeting-title').value;
            const updatedDate = document.getElementById('edit-meeting-date').value;
            const updatedSummary = document.getElementById('edit-meeting-summary').value;
            const updatedParticipants = Array.from(document.querySelectorAll('.edit-participant-checkbox:checked')).map(cb => cb.value);

            if (!updatedTitle || !updatedDate || !updatedSummary || updatedParticipants.length === 0) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            MOCK_MEETINGS[meetingIndex] = {
                ...MOCK_MEETINGS[meetingIndex],
                title: updatedTitle,
                date: updatedDate,
                summary: updatedSummary,
                participants: updatedParticipants
            };

            alert('Reuni√≥n actualizada con √©xito.');
            document.getElementById('edit-meeting-modal').classList.add('hidden');
            renderMeetings();
        };

        // --- AI Meeting Processing ---
        async function handleProcessMeetingAI() {
            if (GEMINI_API_KEY === "AQUI_VA_TU_API_KEY_DE_GEMINI" || !GEMINI_API_KEY) {
                alert("API Key de Gemini no configurada. Por favor, a√±√°dela en el script.");
                return;
            }
            const notes = document.getElementById('meeting-notes-text').value;
            if (!notes) {
                alert('Por favor, pega las notas de la reuni√≥n en el √°rea de texto.');
                return;
            }
            const loader = document.getElementById('ai-loader');
            loader.classList.remove('hidden');

            try {
                const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });

                const userNames = Object.values(MOCK_USERS).map(user => user.name).join(", ");
                const prompt = `Analiza las siguientes notas de una reuni√≥n. Tu tarea es extraer dos cosas y devolverlas en formato JSON: 1. Un resumen ejecutivo ("summary") que destaque los puntos clave y compromisos. 2. Una lista de los nombres de los participantes ("participants") mencionados en el texto que tambi√©n est√°n en esta lista de usuarios del sistema: [${userNames}]. Notas: --- ${notes} --- Responde √∫nicamente con un objeto JSON v√°lido.`;
                
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();
                
                const cleanedText = text.replace(/```json/g, "").replace(/```/g, "").trim();
                const aiResult = JSON.parse(cleanedText);
                
                if (!aiResult.summary || !aiResult.participants) throw new Error("La IA no devolvi√≥ el formato esperado.");

                document.getElementById('meeting-summary').value = aiResult.summary;
                document.querySelectorAll('.participant-checkbox').forEach(cb => cb.checked = false);
                
                aiResult.participants.forEach(nameFromAI => {
                    const foundEntry = Object.entries(MOCK_USERS).find(([id, user]) => user.name.toLowerCase().includes(nameFromAI.toLowerCase()));
                    if (foundEntry) {
                        const checkbox = document.querySelector(`.participant-checkbox[value="${foundEntry[0]}"]`);
                        if (checkbox) checkbox.checked = true;
                    }
                });

                alert('¬°An√°lisis con IA completado!');
            } catch (error) {
                console.error("Error calling AI function:", error);
                alert("Ocurri√≥ un error al procesar las notas con IA: " + error.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function initializeAppUI() {
            if (!currentUser) { showScreen('login'); return; }
            whatsappButton.classList.remove('hidden');
            renderHeader();
            renderAdminPanels();
            renderAnnouncements();
            renderMeetings();
            renderDirectory();
            showScreen('app');
        }

        // --- GLOBAL EVENT LISTENERS ---
        document.querySelectorAll('#register-link, #login-link-from-register, #login-link-from-forgot, #forgot-password-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (link.id === 'register-link') showScreen('register');
                else if (link.id === 'forgot-password-link') showScreen('forgot');
                else showScreen('login');
            });
        });

        googleLoginButton.addEventListener('click', () => alert('Inicio de sesi√≥n con Google pronto disponible.'));
        loginForm.addEventListener('submit', handleEmailLogin);
        registerForm.addEventListener('submit', handleRegister);
        forgotPasswordForm.addEventListener('submit', handleForgotPassword);
        document.getElementById('add-user-form')?.addEventListener('submit', handleManualAddUser);
        logoutButton.addEventListener('click', handleLogout);
        profileButton.addEventListener('click', () => { renderProfileForm(); showScreen('profile'); });
        saveProfileButton.addEventListener('click', handleSaveProfile);
        cancelProfileButton.addEventListener('click', () => showScreen('app'));
        searchDirectoryInput.addEventListener('input', (e) => renderDirectory(e.target.value));
        document.getElementById('submit-announcement')?.addEventListener('click', handleSubmitAnnouncement);
        document.getElementById('submit-meeting')?.addEventListener('click', handleSubmitMeeting);
        processMeetingAIButton?.addEventListener('click', handleProcessMeetingAI);
        document.getElementById('close-modal-button').addEventListener('click', () => document.getElementById('user-details-modal').classList.add('hidden'));
        document.getElementById('save-meeting-changes').addEventListener('click', handleSaveChangesToMeeting);
        document.getElementById('cancel-edit-meeting').addEventListener('click', () => document.getElementById('edit-meeting-modal').classList.add('hidden'));
        document.getElementById('meeting-date')?.addEventListener('change', (e) => {
            document.getElementById('meeting-title').value = `Reuni√≥n 7x7 - ${e.target.value}`;
        });

        // Start the app
        showScreen('login');
        lucide.createIcons();
    </script>
</body>
</html>

